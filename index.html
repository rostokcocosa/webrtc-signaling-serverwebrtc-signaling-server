<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Видеозвонок</title>
    <!-- Подключаем библиотеку Socket.io для сигнализации -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .video-container {
            position: relative;
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }
        #localVideo {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 30%;
            height: auto;
            border-radius: 8px;
            z-index: 10;
        }
        #remoteVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-2xl text-center">
        <h1 class="text-3xl font-bold mb-2">WebRTC Корпоративный Звонок</h1>
        <p class="text-gray-400 mb-6">Базовая демонстрация видеосвязи</p>

        <div class="video-container mb-6 shadow-lg">
            <video id="remoteVideo" class="rounded-lg border-2 border-gray-700" autoplay playsinline></video>
            <video id="localVideo" class="rounded-lg border-2 border-gray-700 shadow-md" muted autoplay playsinline></video>
        </div>

        <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="callButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105 shadow-md">
                Начать звонок
            </button>
            <button id="hangupButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105 shadow-md" disabled>
                Завершить звонок
            </button>
        </div>
        
        <div id="messageBox" class="mt-6 p-4 rounded-lg bg-gray-700 text-gray-200 hidden"></div>
    </div>

    <script>
        // Функция для отображения сообщений пользователю
        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `mt-6 p-4 rounded-lg text-white font-semibold ${isError ? 'bg-red-600' : 'bg-gray-700'} block`;
        }

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');

        let localStream;
        let peerConnection;
        // Убедитесь, что URL соответствует вашему запущенному серверу
        const signalingServerUrl = 'http://localhost:3000'; 

        // PeerConnection использует публичные STUN-серверы для обхода NAT
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Подключаемся к сигнальному серверу
        const socket = io(signalingServerUrl);

        socket.on('connect', () => {
            console.log('Подключено к сигнальному серверу');
            showMessage('Подключено к серверу, готово к звонку');
        });

        socket.on('message', async (message) => {
            console.log('Получено сообщение от сервера:', message);

            // Если получено предложение (offer) от другого пользователя
            if (message.type === 'offer') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('message', peerConnection.localDescription);
            } 
            // Если получен ответ (answer) на наше предложение
            else if (message.type === 'answer') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message));
            } 
            // Если получены ICE-кандидаты
            else if (message.type === 'candidate') {
                const candidate = new RTCIceCandidate({
                    sdpMid: message.sdpMid,
                    sdpMLineIndex: message.sdpMLineIndex,
                    candidate: message.candidate,
                });
                await peerConnection.addIceCandidate(candidate);
            }
        });

        // Обработчик нажатия кнопки "Начать звонок"
        callButton.onclick = async () => {
            callButton.disabled = true;
            hangupButton.disabled = false;
            
            try {
                // Получаем доступ к медиа-устройствам (камере и микрофону)
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                localVideo.play();
                showMessage('Локальный поток получен. Создание соединения...');

                // Создаем новый PeerConnection
                peerConnection = new RTCPeerConnection(configuration);

                // Добавляем локальные потоки в соединение
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Обработчик события, когда удаленный поток готов
                peerConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideo.play();
                    showMessage('Удаленный поток получен. Звонок установлен!');
                };

                // Обработчик для сбора ICE-кандидатов
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('message', {
                            type: 'candidate',
                            sdpMid: event.candidate.sdpMid,
                            sdpMLineIndex: event.candidate.sdpMLineIndex,
                            candidate: event.candidate.candidate
                        });
                    }
                };

                // Создаем предложение (offer) и отправляем его на сигнальный сервер
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('message', peerConnection.localDescription);
                showMessage('Предложение отправлено. Ожидание ответа...');

            } catch (error) {
                console.error('Ошибка при создании звонка:', error);
                showMessage(`Ошибка: ${error.message}`, true);
            }
        };

        // Обработчик нажатия кнопки "Завершить звонок"
        hangupButton.onclick = () => {
            peerConnection.close();
            localStream.getTracks().forEach(track => track.stop());
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            callButton.disabled = false;
            hangupButton.disabled = true;
            showMessage('Звонок завершен.');
        };
    </script>
</body>
</html>
